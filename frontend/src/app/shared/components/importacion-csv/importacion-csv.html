<p-toast />

<p-dialog 
  [header]="'Importar ' + tipoImportacion()" 
  [(visible)]="visible" 
  [modal]="true"
  [style]="{ width: '50rem' }"
  [draggable]="false"
  [resizable]="false">
  
  <div class="flex flex-col gap-4">
    
    <!-- Sección de descarga de plantilla -->
    <div class="flex items-center gap-2 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
      <i class="pi pi-info-circle text-blue-600 dark:text-blue-400 text-xl"></i>
      <div class="flex-1">
        <p class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-1">
          Descarga la plantilla CSV
        </p>
        <p class="text-xs text-blue-700 dark:text-blue-300">
          Usa la plantilla para asegurar el formato correcto de los datos
        </p>
      </div>
      <p-button 
        label="Descargar plantilla" 
        icon="pi pi-download"
        [outlined]="true"
        severity="info"
        size="small"
        (onClick)="descargarPlantilla()" />
    </div>

    <!-- Selector de archivo -->
    <div class="flex flex-col gap-2">
      <label class="font-semibold text-sm">Seleccionar archivo CSV</label>
      <p-fileupload 
        mode="basic"
        chooseLabel="Seleccionar CSV"
        chooseIcon="pi pi-upload"
        [auto]="false"
        accept=".csv"
        [maxFileSize]="10000000"
        (onSelect)="onFileSelect($event)"
        [disabled]="validando() || importando()" />
      
      @if (archivoSeleccionado()) {
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-file text-green-600"></i>
          <span class="font-medium">{{ archivoSeleccionado()?.name }}</span>
          <span class="text-gray-500">({{ (archivoSeleccionado()?.size ?? 0) / 1024 | number:'1.0-0' }} KB)</span>
        </div>
      }
    </div>

    <!-- Barra de progreso durante validación -->
    @if (validando()) {
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2">
          <i class="pi pi-spin pi-spinner text-blue-600"></i>
          <span class="text-sm font-medium">Validando archivo...</span>
        </div>
        <p-progressbar mode="indeterminate" [style]="{ height: '6px' }" />
      </div>
    }

    <!-- Resultado de validación -->
    @if (resultadoValidacion() && !validando()) {
      <div class="flex flex-col gap-3 p-4 rounded-lg border"
           [ngClass]="{
             'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800': archivoValidado(),
             'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800': !archivoValidado()
           }">
        
        <div class="flex items-center gap-2">
          <i [class]="archivoValidado() ? 'pi pi-check-circle text-green-600' : 'pi pi-exclamation-circle text-red-600'"
             class="text-xl"></i>
          <span class="font-semibold text-sm"
                [ngClass]="{
                  'text-green-900 dark:text-green-100': archivoValidado(),
                  'text-red-900 dark:text-red-100': !archivoValidado()
                }">
            {{ archivoValidado() ? 'Validación exitosa' : 'Errores encontrados' }}
          </span>
        </div>

        <div class="grid grid-cols-3 gap-2 text-sm">
          <div class="flex flex-col">
            <span class="text-gray-600 dark:text-gray-400 text-xs">Total</span>
            <span class="font-bold">{{ resultadoValidacion()?.registrosProcesados }}</span>
          </div>
          <div class="flex flex-col">
            <span class="text-green-600 dark:text-green-400 text-xs">Válidos</span>
            <span class="font-bold text-green-700 dark:text-green-300">
              {{ resultadoValidacion()?.registrosExitosos }}
            </span>
          </div>
          <div class="flex flex-col">
            <span class="text-red-600 dark:text-red-400 text-xs">Errores</span>
            <span class="font-bold text-red-700 dark:text-red-300">
              {{ resultadoValidacion()?.registrosFallidos }}
            </span>
          </div>
        </div>

        @if (!archivoValidado() && resultadoValidacion()?.errores && resultadoValidacion()!.errores.length > 0) {
          <p-button 
            label="Ver detalles de errores"
            icon="pi pi-list"
            [text]="true"
            severity="danger"
            size="small"
            (onClick)="verErrores()" />
        }
      </div>
    }

    <!-- Barra de progreso durante importación -->
    @if (importando()) {
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-2">
          <i class="pi pi-spin pi-spinner text-green-600"></i>
          <span class="text-sm font-medium">Importando datos...</span>
        </div>
        <p-progressbar mode="indeterminate" [style]="{ height: '6px' }" />
      </div>
    }

  </div>

  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancelar" 
        severity="secondary"
        [outlined]="true"
        (onClick)="closeDialog()"
        [disabled]="validando() || importando()" />
      
      @if (!archivoValidado() && archivoSeleccionado()) {
        <p-button 
          label="Validar archivo"
          icon="pi pi-check"
          (onClick)="validarArchivo()"
          [disabled]="validando() || importando()"
          [loading]="validando()" />
      }
      
      @if (archivoValidado()) {
        <p-button 
          label="Importar datos"
          icon="pi pi-upload"
          severity="success"
          (onClick)="importarArchivo()"
          [disabled]="validando() || importando()"
          [loading]="importando()" />
      }
    </div>
  </ng-template>

</p-dialog>

<!-- Dialog de errores -->
<p-dialog 
  header="Detalle de errores"
  [(visible)]="mostrarErrores"
  [modal]="true"
  [style]="{ width: '60rem' }"
  [draggable]="false">
  
  @if (resultadoValidacion()?.errores && resultadoValidacion()!.errores.length > 0) {
    <p-table 
      [value]="resultadoValidacion()!.errores"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [scrollable]="true"
      scrollHeight="400px"
      styleClass="p-datatable-sm">
      
      <ng-template #header>
        <tr>
          <th style="width: 5rem">Línea</th>
          <th style="width: 15rem">Identificador</th>
          <th style="width: 10rem">Campo</th>
          <th style="width: 10rem">Valor</th>
          <th>Error</th>
        </tr>
      </ng-template>
      
      <ng-template #body let-error>
        <tr>
          <td>{{ error.linea }}</td>
          <td>{{ error.identificador }}</td>
          <td>
            <p-tag [value]="error.campo" severity="info" />
          </td>
          <td>
            <span class="text-xs font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
              {{ error.valorInvalido || 'N/A' }}
            </span>
          </td>
          <td>
            <span class="text-sm text-red-600 dark:text-red-400">
              {{ error.mensajeError }}
            </span>
          </td>
        </tr>
      </ng-template>
      
    </p-table>
  }

  <ng-template #footer>
    <p-button 
      label="Cerrar" 
      severity="secondary"
      (onClick)="cerrarErrores()" />
  </ng-template>

</p-dialog>
