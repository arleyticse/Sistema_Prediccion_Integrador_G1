<div class="recovery-container">
  <p-card class="recovery-card">
    <!-- Header -->
    <ng-template #header>
      <div class="card-header">
        <i class="pi pi-lock" style="font-size: 3rem;"></i>
        <h2>{{ currentStep() === 'success' ? '¡Contraseña Restablecida!' : 'Recuperar Contraseña' }}</h2>
        <p class="subtitle">{{ getStepSubtitle() }}</p>
      </div>
    </ng-template>

    <!-- Mensajes de error/éxito -->
    @if (errorMessage()) {
      <p-message severity="error" [text]="errorMessage()!" styleClass="w-full mb-4" />
    }
    @if (successMessage() && currentStep() !== 'success') {
      <p-message severity="success" [text]="successMessage()!" styleClass="w-full mb-4" />
    }

    <!-- Paso 1: Ingresar Email -->
    @if (currentStep() === 'email') {
      <div class="step-content">
        <p-floatlabel>
          <input 
            pInputText 
            id="email" 
            [(ngModel)]="email"
            type="email"
            class="w-full"
            [disabled]="loading()"
            (keyup.enter)="requestPasswordReset()"
          />
          <label for="email">Correo Electrónico</label>
        </p-floatlabel>

        <div class="button-group">
          <p-button
            label="Enviar Código"
            icon="pi pi-send"
            [loading]="loading()"
            [disabled]="!canSubmitEmail()"
            (onClick)="requestPasswordReset()"
            styleClass="w-full"
          />
          <p-button
            label="Volver al Login"
            icon="pi pi-arrow-left"
            severity="secondary"
            [text]="true"
            (onClick)="goToLogin()"
            styleClass="w-full"
          />
        </div>
      </div>
    }

    <!-- Paso 2: Ingresar código OTP -->
    @if (currentStep() === 'otp') {
      <div class="step-content">
        <div class="otp-info">
          <i class="pi pi-envelope otp-envelope-icon"></i>
          <p>Hemos enviado un código de 6 dígitos a:</p>
          <strong>{{ email() }}</strong>
          @if (expiryTime()) {
            <small>El código expira en {{ expiryTime() }}</small>
          }
        </div>

        <div class="otp-container">
          <label for="otp">Ingresa el código de verificación</label>
          <p-inputotp 
            [(ngModel)]="otpCode"
            [length]="6"
            [integerOnly]="true"
            styleClass="otp-input"
          />
        </div>

        <div class="button-group">
          <p-button
            label="Verificar Código"
            icon="pi pi-check"
            [loading]="loading()"
            [disabled]="!canVerifyOtp()"
            (onClick)="verifyOtpCode()"
            styleClass="w-full"
          />
          <p-button
            label="Reenviar Código"
            icon="pi pi-refresh"
            severity="secondary"
            [text]="true"
            [disabled]="loading()"
            (onClick)="resendCode()"
            styleClass="w-full"
          />
          <p-button
            label="Cambiar Email"
            icon="pi pi-arrow-left"
            severity="secondary"
            [text]="true"
            (onClick)="restart()"
            styleClass="w-full"
          />
        </div>
      </div>
    }

    <!-- Paso 3: Nueva contraseña -->
    @if (currentStep() === 'password') {
      <div class="step-content">
        <p-floatlabel>
          <input 
            pInputText 
            id="newPassword" 
            [(ngModel)]="newPassword"
            type="password"
            class="w-full"
            [disabled]="loading()"
          />
          <label for="newPassword">Nueva Contraseña</label>
        </p-floatlabel>

        <p-floatlabel>
          <input 
            pInputText 
            id="confirmPassword" 
            [(ngModel)]="confirmPassword"
            type="password"
            class="w-full"
            [disabled]="loading()"
            (keyup.enter)="resetPassword()"
          />
          <label for="confirmPassword">Confirmar Contraseña</label>
        </p-floatlabel>

        @if (newPassword() && !isPasswordValid()) {
          <p-message severity="warn" text="La contraseña debe tener al menos 6 caracteres" styleClass="w-full" />
        }
        @if (confirmPassword() && !passwordsMatch()) {
          <p-message severity="warn" text="Las contraseñas no coinciden" styleClass="w-full" />
        }

        <div class="button-group">
          <p-button
            label="Restablecer Contraseña"
            icon="pi pi-check-circle"
            [loading]="loading()"
            [disabled]="!canResetPassword()"
            (onClick)="resetPassword()"
            styleClass="w-full"
          />
        </div>
      </div>
    }

    <!-- Paso 4: Éxito -->
    @if (currentStep() === 'success') {
      <div class="step-content success-content">
        <div class="success-icon">
          <i class="pi pi-check-circle success-check-icon"></i>
        </div>
        <p-message severity="success" [text]="successMessage()!" styleClass="w-full mb-4" />
        <p class="redirect-info">Serás redirigido al login en 3 segundos...</p>
        <p-button
          label="Ir al Login Ahora"
          icon="pi pi-sign-in"
          (onClick)="goToLogin()"
          styleClass="w-full"
        />
      </div>
    }

    <!-- Loading spinner -->
    @if (loading()) {
      <div class="loading-overlay">
        <p-progressspinner strokeWidth="4" />
      </div>
    }
  </p-card>
</div>
