<div class="mb-4 flex justify-between">
    <p-button (click)="abrirImportacion()" label="Importar CSV" icon="pi pi-upload" severity="info" [outlined]="true" />
    <p-button (click)="showDialog()" label="Nuevo Producto" icon="pi pi-plus" />
</div>

<!-- Componente de importación -->
<app-importacion-csv #importacionCsv endpoint="/importacion/productos" tipoImportacion="Productos"
    nombrePlantilla="plantilla_productos.csv" (importacionCompletada)="cargarProductos()" />

<p-dialog [visible]="visible()" (visibleChange)="visible.set($event)" [modal]="true" [draggable]="false"
    [style]="{ width: '50rem' }" [contentStyle]="{ 'padding': '1.25rem', 'overflow': 'visible' }">
    <ng-template #header>
        <h2 class="text-3xl">{{ isEditing() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
    </ng-template>
    <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="min-h-[27rem]">
        <div class=" space-y-6">
            <!-- Sección 1: Nombre (full width) -->
            <div class="field">
                <p-floatlabel>
                    <input id="nombre" pInputText formControlName="nombre" class="w-full"
                        [invalid]="productoForm.get('nombre')?.hasError('required')&& productoForm.get('nombre')?.touched" />
                    <label for="nombre">Nombre</label>
                </p-floatlabel>
                @if (productoForm.get('nombre')?.hasError('required') && productoForm.get('nombre')?.touched) {
                <p-message severity="error" variant="simple" size="small">El nombre es requerido</p-message>
                }
            </div>

            <!-- Sección 2: Categoría y Unidad de Medida (2 columnas) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="field">
                    <p-select id="categoria" [options]="categorias()" optionLabel="nombre" [showClear]="true"
                        placeholder="Seleccionar una categoría" formControlName="categoria" class="w-full"
                        [invalid]="productoForm.get('categoria')?.hasError('required') && productoForm.get('categoria')?.touched" />
                    @if (productoForm.get('categoria')?.hasError('required') && productoForm.get('categoria')?.touched)
                    {
                    <p-message severity="error" variant="simple" size="small">La categoría es requerida</p-message>
                    }
                </div>

                <div class="field">
                    <p-select id="unidadMedida" [options]="unidadMedidas()" optionLabel="nombre" [showClear]="true"
                        placeholder="Seleccionar unidad" formControlName="unidadMedida" class="w-full"
                        [invalid]="productoForm.get('unidadMedida')?.hasError('required') && productoForm.get('unidadMedida')?.touched" />
                    @if (productoForm.get('unidadMedida')?.hasError('required') &&
                    productoForm.get('unidadMedida')?.touched) {
                    <p-message severity="error" variant="simple" size="small">La unidad es requerida</p-message>
                    }
                </div>
            </div>

            <!-- Sección 3: Proveedor y Lead Time (2 columnas) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="field">
                    <p-select id="proveedor" [options]="proveedores()" optionLabel="nombreComercial" [filter]="true"
                        placeholder="Seleccionar un proveedor principal" formControlName="proveedor" class="w-full"
                        [invalid]="productoForm.get('proveedor')?.hasError('required') && productoForm.get('proveedor')?.touched">
                    </p-select>
                    @if (productoForm.get('proveedor')?.hasError('required') && productoForm.get('proveedor')?.touched)
                    {
                    <p-message severity="error" variant="simple" size="small">El proveedor es requerido</p-message>
                    }
                </div>

                <div class="field">
                    <p-floatlabel>
                        <p-inputNumber inputId="diasLeadTime" formControlName="diasLeadTime" [min]="1" class="w-full"
                            suffix=" días" [max]="30"
                            [invalid]="productoForm.get('diasLeadTime')?.hasError('required') && productoForm.get('diasLeadTime')?.touched" />
                        <label for="diasLeadTime">Días de Lead Time</label>
                    </p-floatlabel>
                    @if (productoForm.get('diasLeadTime')?.hasError('required') &&
                    productoForm.get('diasLeadTime')?.touched) {
                    <p-message severity="error" variant="simple" size="small">Días requerido</p-message>
                    }
                </div>
            </div>

            <!-- Sección 4: Costos (3 columnas en lg, 2 en md, 1 en sm) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="field">
                    <p-floatlabel>
                        <p-inputNumber inputId="costoAdquisicion" formControlName="costoAdquisicion" [min]="0"
                            mode="decimal" [minFractionDigits]="2" class="w-full" suffix=" soles "
                            [invalid]="productoForm.get('costoAdquisicion')?.hasError('required') && productoForm.get('costoAdquisicion')?.touched" />
                        <label for="costoAdquisicion">Costo Adquisición</label>
                    </p-floatlabel>
                    @if (productoForm.get('costoAdquisicion')?.hasError('required') &&
                    productoForm.get('costoAdquisicion')?.touched) {
                    <p-message severity="error" variant="simple" size="small">Costo requerido</p-message>
                    }
                </div>

                <div class="field">
                    <p-floatlabel>
                        <p-inputNumber inputId="costoMantenimiento" formControlName="costoMantenimiento" [min]="0"
                            mode="decimal" [minFractionDigits]="2" class="w-full" suffix=" soles "
                            [invalid]="productoForm.get('costoMantenimiento')?.hasError('required') && productoForm.get('costoMantenimiento')?.touched" />
                        <label for="costoMantenimiento">Costo Mantenimiento</label>
                    </p-floatlabel>
                    @if (productoForm.get('costoMantenimiento')?.hasError('required') &&
                    productoForm.get('costoMantenimiento')?.touched) {
                    <p-message severity="error" variant="simple" size="small">Costo requerido</p-message>
                    }
                </div>

                <div class="field">
                    <p-floatlabel>
                        <p-inputNumber inputId="costoPedido" formControlName="costoPedido" [min]="0" mode="decimal"
                            [minFractionDigits]="2" class="w-full" suffix=" soles "
                            [invalid]="productoForm.get('costoPedido')?.hasError('required') && productoForm.get('costoPedido')?.touched" />
                        <label for="costoPedido">Costo Pedido</label>
                    </p-floatlabel>
                    @if (productoForm.get('costoPedido')?.hasError('required') &&
                    productoForm.get('costoPedido')?.touched) {
                    <p-message severity="error" variant="simple" size="small">Costo requerido</p-message>
                    }
                </div>
            </div>
        </div>
    </form>

    <ng-template #footer>
        <p-button [label]="isEditing() ? 'Actualizar' : 'Guardar'" icon="pi pi-check" (onClick)="onSubmit()"
            [disabled]="productoForm.invalid" />
        <p-button label="Cancelar" icon="pi pi-times" severity="danger" (click)="closeDialog()" />
    </ng-template>
</p-dialog>

<div class="card mb-4">
    <div class="flex justify-between items-center gap-2">
        <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpiar" (click)="clearSearch()" />
        <p-iconField iconPosition="left">
            <p-inputIcon>
                @if (loading()) {
                <i class="pi pi-spin pi-spinner"></i>
                } @else {
                <i class="pi pi-search"></i>
                }
            </p-inputIcon>
            <input pInputText type="text" [value]="searchValue()" (input)="onSearchChange($event.target.value)"
                placeholder="Buscar productos..." />
        </p-iconField>
    </div>
</div>
@if (loading()) {
<!-- Skeleton Loading State -->
<div class="space-y-3">
    <p-skeleton height="3rem" styleClass="mb-3"></p-skeleton>
    @for (item of [1,2,3,4,5,6,7]; track item) {
    <div class="flex gap-3">
        <p-skeleton width="20%" height="2.5rem"></p-skeleton>
        <p-skeleton width="15%" height="2.5rem"></p-skeleton>
        <p-skeleton width="15%" height="2.5rem"></p-skeleton>
        <p-skeleton width="10%" height="2.5rem"></p-skeleton>
        <p-skeleton width="12%" height="2.5rem"></p-skeleton>
        <p-skeleton width="10%" height="2.5rem"></p-skeleton>
        <p-skeleton width="18%" height="2.5rem"></p-skeleton>
    </div>
    }
</div>
} @else {
<p-table #dt [columns]="cols" [value]="productos()" [scrollable]="true" scrollHeight="400px"
    [tableStyle]="{ 'min-width': '50rem' }">
    <ng-template #header let-columns>
        <tr>
            @for (col of columns; track col.field) {
            <th>{{ col.header }}</th>
            }
        </tr>
    </ng-template>
    <ng-template #body let-rowData let-columns="columns">
        <tr>
            @for (col of columns; track col.field) {
            @if (col.field === 'acciones') {
            <td>
                <p-button icon="pi pi-history" [rounded]="true" [text]="true" label="" severity="secondary"
                    (onClick)="verKardex(rowData)" pTooltip="Ver Movimientos" tooltipPosition="top" />
                <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" label="" severity="info"
                    (onClick)="editar(rowData)" pTooltip="Editar" tooltipPosition="top" />
                <p-button icon="pi pi-trash" [rounded]="true" [text]="true" label="" severity="danger"
                    (onClick)="eliminar(rowData)" pTooltip="Eliminar" tooltipPosition="top" />
            </td>
            } @else if (col.field === 'categoria') {
            <td>{{ rowData.categoria.nombre }}</td>
            } @else if (col.field === 'unidadMedida') {
            <td>{{ rowData.unidadMedida.nombre }}</td>
            } @else if (col.field === 'estadoInventario') {
            <td>
                <p-tag [value]="rowData.estadoInventario | estadoInventario" 
                       [severity]="rowData.estadoInventario | estadoInventarioSeverity" 
                       [rounded]="true" />
            </td>
            } @else {
            <td>{{ rowData[col.field] }}</td>
            }
            }@empty {
            <td [attr.colspan]="cols.length" class="text-center py-4">
                <p class="text-gray-500">No hay productos registrados</p>
            </td>
            }
        </tr>
    </ng-template>
</p-table>
}
<div class="card flex justify-center mt-4">
    <p-paginator (onPageChange)="onPageChange($event)" [first]="first()" [rows]="rows()" [totalRecords]="totalRecords()"
        [rowsPerPageOptions]="rowsPerPageOptions" />
</div>
<p-confirmDialog />

<!-- Modal de Movimientos Kardex -->
<p-dialog [visible]="kardexVisible()" (visibleChange)="kardexVisible.set($event)" [modal]="true" [draggable]="false"
    [style]="{ width: '60rem', maxHeight: '90vh' }" [contentStyle]="{ 'overflow-y': 'auto', 'padding': '1.5rem' }">
    <ng-template #header>
        <div class="flex items-center gap-3">
            <i class="pi pi-history text-2xl text-primary-500"></i>
            <div>
                <h2 class="text-xl font-semibold m-0">Historial de Movimientos</h2>
                @if (productoSeleccionadoKardex()) {
                <p class="text-sm text-surface-500 m-0">{{ productoSeleccionadoKardex()?.nombre }}</p>
                }
            </div>
        </div>
    </ng-template>

    <div class="min-h-[300px]">
        @if (kardexLoading()) {
        <!-- Skeleton Loading -->
        <div class="space-y-4">
            @for (item of [1,2,3,4,5]; track item) {
            <div class="flex gap-4 items-start">
                <p-skeleton shape="circle" width="2.5rem" height="2.5rem"></p-skeleton>
                <div class="flex-1">
                    <p-skeleton width="40%" height="1.25rem" styleClass="mb-2"></p-skeleton>
                    <p-skeleton width="80%" height="1rem"></p-skeleton>
                </div>
            </div>
            }
        </div>
        } @else if (movimientos().length === 0) {
        <!-- Estado vacío -->
        <div class="flex flex-col items-center justify-center py-12 text-center">
            <i class="pi pi-inbox text-6xl text-surface-300 mb-4"></i>
            <h3 class="text-lg font-medium text-surface-600 mb-2">Sin movimientos</h3>
            <p class="text-surface-500">Este producto aún no tiene movimientos registrados en el Kardex.</p>
        </div>
        } @else {
        <!-- Timeline de movimientos -->
        <p-timeline [value]="movimientos()" align="alternate" styleClass="w-full dark:bg-gray-800 dark:text-white">
            <ng-template #marker let-mov>
                <span class="flex items-center justify-center w-10 h-10 rounded-full shadow-md dark:bg-gray-700 dark:text-gray-300"
                    [ngClass]="{
                        'bg-green-100 text-green-600': esEntrada(mov.tipoMovimiento),
                        'bg-red-100 text-red-600': esSalida(mov.tipoMovimiento),
                        'bg-blue-100 text-blue-600': !esEntrada(mov.tipoMovimiento) && !esSalida(mov.tipoMovimiento)
                    }">
                    <i [class]="getIconoTipo(mov.tipoMovimiento)"></i>
                </span>
            </ng-template>
            <ng-template #content let-mov>
                <div class="bg-surface-50 rounded-lg p-4 shadow-sm border border-surface-200 mb-4 hover:shadow-md transition-shadow dark:bg-gray-700 dark:border-gray-600">
                    <!-- Header del movimiento -->
                    <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                        <div class="flex items-center gap-2">
                            <p-tag [value]="mov.tipoMovimiento | tipoMovimiento" 
                                   [severity]="mov.tipoMovimiento | tipoMovimientoSeverity" 
                                   [rounded]="true" />
                            @if (mov.numeroDocumento) {
                            <span class="text-sm text-surface-500">
                                {{ mov.numeroDocumento }}
                            </span>
                            }
                        </div>
                        <span class="text-sm text-surface-500">
                            <i class="pi pi-calendar mr-1"></i>{{ mov.fechaMovimiento | date:'dd/MM/yyyy HH:mm' }}
                        </span>
                    </div>

                    <!-- Detalles del movimiento -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div class="flex flex-col">
                            <span class="text-surface-500 text-xs uppercase tracking-wide">Cantidad</span>
                            <span class="font-semibold text-lg">
                                {{ mov.cantidad }}
                            </span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-surface-500 text-xs uppercase tracking-wide">Saldo</span>
                            <span class="font-medium">{{ mov.saldoCantidad }}</span>
                        </div>
                        @if (mov.costoUnitario) {
                        <div class="flex flex-col">
                            <span class="text-surface-500 text-xs uppercase tracking-wide">Costo Unit.</span>
                            <span class="font-medium">S/ {{ mov.costoUnitario | number:'1.2-2' }}</span>
                        </div>
                        }
                        @if (mov.valorTotal) {
                        <div class="flex flex-col">
                            <span class="text-surface-500 text-xs uppercase tracking-wide">Valor Total</span>
                            <span class="font-medium">S/ {{ mov.valorTotal | number:'1.2-2' }}</span>
                        </div>
                        }
                    </div>

                    <!-- Información adicional -->
                    @if (mov.motivo || mov.observaciones || mov.nombreProveedor || mov.lote) {
                    <div class="mt-3 pt-3 border-t border-surface-200 dark:border-gray-600">
                        <div class="flex flex-wrap gap-4 text-sm text-surface-600 dark:text-gray-300">
                            @if (mov.nombreProveedor) {
                            <span><i class="pi pi-building mr-1"></i>{{ mov.nombreProveedor }}</span>
                            }
                            @if (mov.lote) {
                            <span><i class="pi pi-box mr-1"></i>Lote: {{ mov.lote }}</span>
                            }
                            @if (mov.nombreUsuario) {
                            <span><i class="pi pi-user mr-1"></i>{{ mov.nombreUsuario }}</span>
                            }
                        </div>
                        @if (mov.motivo) {
                        <p class="mt-2 text-sm text-surface-600 dark:text-gray-300">
                            <strong>Motivo:</strong> {{ mov.motivo }}
                        </p>
                        }
                        @if (mov.observaciones) {
                        <p class="mt-1 text-sm text-surface-500 dark:text-gray-400 italic">{{ mov.observaciones }}</p>
                        }
                    </div>
                    }
                </div>
            </ng-template>
        </p-timeline>
        }
    </div>

    <ng-template #footer>
        <div class="flex justify-end">
            <p-button label="Cerrar" icon="pi pi-times" severity="secondary" (onClick)="cerrarKardex()" />
        </div>
    </ng-template>
</p-dialog>