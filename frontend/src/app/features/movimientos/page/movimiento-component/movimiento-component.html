<p>Movimientos</p>
<div class="mb-4 flex justify-between">
    <p-button 
        (click)="abrirImportacion()" 
        label="Importar CSV" 
        icon="pi pi-upload"
        severity="info"
        [outlined]="true" />
    <p-button (click)="showDialog()" label="Nuevo Movimiento" icon="pi pi-plus" />
</div>

<!-- Componente de importación -->
<app-importacion-csv
    #importacionCsv
    endpoint="/importacion/kardex"
    tipoImportacion="Movimientos (Kardex)"
    nombrePlantilla="plantilla_kardex.csv"
    (importacionCompletada)="cargarMovimientos()" />

<p-dialog [visible]="visible()" (visibleChange)="visible.set($event)" [modal]="true" [style]="{ width: '35rem' }">
    <ng-template #header>
        <h2>Registrar Nuevo Movimiento</h2>
    </ng-template>
    <form [formGroup]="movimientoForm" (ngSubmit)="onSubmit()">
        <div class="p-fluid">
            <!-- Producto con búsqueda y virtual scroll -->
            <div class="flex flex-col mb-4">
                <label for="producto">Producto *</label>
                <p-select 
                    id="producto" 
                    [options]="productos()" 
                    optionLabel="nombre"
                    optionValue="productoId"
                    placeholder="Buscar un producto..."
                    [filter]="true"
                    filterBy="nombre"
                    [showClear]="true"
                    [virtualScroll]="true"
                    [virtualScrollItemSize]="38"
                    [loading]="loadingProductos()"
                    formControlName="productoId">
                    <ng-template #selectedItem let-option>
                        @if (option) {
                            <div class="flex flex-col gap-1">
                                <span class="font-semibold">{{ option.nombre }}</span>
                                <span class="text-sm text-gray-500">{{ option.categoria?.nombre }}</span>
                            </div>
                        }
                    </ng-template>
                    <ng-template let-product #item>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ product.nombre }}</span>
                            <span class="text-sm text-gray-500">{{ product.categoria?.nombre }}</span>
                        </div>
                    </ng-template>
                </p-select>
                @if (movimientoForm.get('productoId')?.hasError('required') && movimientoForm.get('productoId')?.touched) {
                    <small class="p-error">El producto es requerido</small>
                }
            </div>

            <!-- Proveedor -->
            <div class="flex flex-col mb-4">
                <label for="proveedorId">Proveedor</label>
                <p-select 
                    id="proveedorId" 
                    [options]="proveedores()" 
                    optionLabel="razonSocial"
                    placeholder="Seleccionar proveedor (opcional)"
                    [filter]="true"
                    filterBy="razonSocial"
                    [loading]="loadingProveedores()"
                    [showClear]="true"
                    formControlName="proveedorId">
                    <ng-template let-option #item>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ option.razonSocial }}</span>
                            <span class="text-sm text-gray-500">{{ option.nombreComercial }}</span>
                        </div>
                    </ng-template>
                </p-select>
            </div>

            <!-- Tipo de Movimiento -->
            <div class="flex flex-col mb-4">
                <label for="tipoMovimiento">Tipo de Movimiento *</label>
                <p-select 
                    id="tipoMovimiento" 
                    [options]="tiposMovimiento()" 
                    optionLabel="descripcion"
                    placeholder="Seleccionar tipo de movimiento"
                    [filter]="true"
                    filterBy="descripcion"
                    [showClear]="true"
                    formControlName="tipoMovimiento">
                    <ng-template let-tipo #item>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ tipo.descripcion }}</span>
                            <span class="text-sm text-gray-400">{{ tipo.valor }}</span>
                        </div>
                    </ng-template>
                </p-select>
                @if (movimientoForm.get('tipoMovimiento')?.hasError('required') && movimientoForm.get('tipoMovimiento')?.touched) {
                    <small class="p-error">El tipo de movimiento es requerido</small>
                }
            </div>

            <!-- Cantidad -->
            <div class="flex flex-col mb-4">
                <label for="cantidad">Cantidad *</label>
                <input id="cantidad" type="number" pInputText formControlName="cantidad" />
                @if (movimientoForm.get('cantidad')?.hasError('required') && movimientoForm.get('cantidad')?.touched) {
                    <small class="p-error">Cantidad requerida</small>
                }
                @if (movimientoForm.get('cantidad')?.hasError('min') && movimientoForm.get('cantidad')?.touched) {
                    <small class="p-error">Cantidad debe ser mayor a 0</small>
                }
            </div>

            <!-- Costo Unitario -->
            <div class="flex flex-col mb-4">
                <label for="costoUnitario">Costo Unitario *</label>
                <input id="costoUnitario" type="number" pInputText formControlName="costoUnitario" />
                @if (movimientoForm.get('costoUnitario')?.hasError('required') && movimientoForm.get('costoUnitario')?.touched) {
                    <small class="p-error">Costo unitario requerido</small>
                }
            </div>

            <!-- Motivo -->
            <div class="flex flex-col mb-4">
                <label for="motivo">Motivo *</label>
                <input id="motivo" type="text" pInputText formControlName="motivo" />
                @if (movimientoForm.get('motivo')?.hasError('required') && movimientoForm.get('motivo')?.touched) {
                    <small class="p-error">El motivo es requerido</small>
                }
            </div>

            <!-- Opcionales -->
            <div class="flex flex-col mb-4">
                <label for="tipoDocumento">Tipo de Documento</label>
                <input id="tipoDocumento" type="text" pInputText formControlName="tipoDocumento" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="numeroDocumento">Número de Documento</label>
                <input id="numeroDocumento" type="text" pInputText formControlName="numeroDocumento" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="lote">Lote</label>
                <input id="lote" type="text" pInputText formControlName="lote" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="fechaVencimiento">Fecha de Vencimiento</label>
                <input id="fechaVencimiento" type="date" pInputText formControlName="fechaVencimiento" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="referencia">Referencia</label>
                <input id="referencia" type="text" pInputText formControlName="referencia" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="observaciones">Observaciones</label>
                <input id="observaciones" type="text" pInputText formControlName="observaciones" />
            </div>

            <div class="flex flex-col mb-4">
                <label for="ubicacion">Ubicación</label>
                <input id="ubicacion" type="text" pInputText formControlName="ubicacion" />
            </div>
        </div>
    </form>

    <ng-template #footer>
        <p-button 
            label="Guardar" 
            icon="pi pi-check" 
            (onClick)="onSubmit()"
            [disabled]="movimientoForm.invalid" />
        <p-button 
            label="Cancelar" 
            icon="pi pi-times" 
            severity="danger"
            (click)="closeDialog()" />
    </ng-template>
</p-dialog>

<div class="card mb-4">
    <div class="flex justify-between items-center gap-2">
        <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpiar" (click)="clearSearch()" />
        <p-iconField iconPosition="left">
            <p-inputIcon>
                <i class="pi pi-search"></i>
            </p-inputIcon>
            <input 
                pInputText 
                type="text"
                [value]="searchValue()"
               (input)="onSearchChange($event.target.value)"
                placeholder="Buscar movimientos..." />
        </p-iconField>
    </div>
</div>

<p-table #dt [columns]="cols" [value]="movimientos()" [scrollable]="true" scrollHeight="400px" [tableStyle]="{ 'min-width': '50rem' }" [loading]="loading()">
    <ng-template #header let-columns>
        <tr>
            @for (col of columns; track col.field) {
                <th>{{ col.header }}</th>
            }
        </tr>
    </ng-template>
    <ng-template #body let-rowData let-columns="columns">
        <tr>
            @for (col of columns; track col.field) {
                @if (col.field === 'acciones') {
                    <td>
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" label="Anular" severity="danger" (onClick)="eliminar(rowData)" />
                    </td>
                } @else {
                    <td>{{ rowData[col.field] }}</td>
                }
            }
        </tr>
    </ng-template>
    <ng-template #emptymessage>
        <tr>
            <td [attr.colspan]="cols.length" class="text-center py-4">
                <p class="text-gray-500">No hay movimientos registrados</p>
            </td>
        </tr>
    </ng-template>
</p-table>

<div class="card flex justify-center mt-4">
    <p-paginator 
        (onPageChange)="onPageChange($event)" 
        [first]="first()" 
        [rows]="rows()" 
        [totalRecords]="totalRecords()" 
        [rowsPerPageOptions]="rowsPerPageOptions" />
</div>

<p-confirmDialog />