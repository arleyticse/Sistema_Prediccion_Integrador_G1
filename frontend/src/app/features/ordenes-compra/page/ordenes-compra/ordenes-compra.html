<div class="ordenes-compra-container">
  <div class="header-section">
    <h2>Órdenes de Compra</h2>
    <p-button 
      (click)="showDialog()" 
      label="Generar Orden" 
      icon="pi pi-plus" 
       />
  </div>

  <!-- Dialog para generar orden -->
  <p-dialog 
    [visible]="visible()" 
    (visibleChange)="visible.set($event)" 
    [modal]="true" 
    [style]="{ width: '30rem' }">
    
    <ng-template #header>
      <h3>Generar Nueva Orden</h3>
    </ng-template>
    
    <form [formGroup]="generarForm" (ngSubmit)="onSubmit()">
      <div class="p-fluid">
        <div class="flex flex-col mb-4">
          <label for="prediccion">Predicción Disponible</label>
          <p-select 
            id="prediccion" 
            [options]="prediccionesDisponibles()" 
            optionLabel="producto.nombre"
            [showClear]="true" 
            placeholder="Seleccionar predicción" 
            formControlName="prediccion">
            <ng-template #selectedItem let-item>
              <div class="flex align-items-center gap-2">
                <span>{{ item.producto.nombre }}</span>
                <small class="text-500">(Demanda: {{ item.demandaPredichaTotal }})</small>
              </div>
            </ng-template>
            <ng-template #item let-item>
              <div class="flex align-items-center gap-2">
                <div>
                  <div>{{ item.producto.nombre }}</div>
                  <small class="text-500">Demanda predicha: {{ item.demandaPredichaTotal }} | Precisión: {{ item.precision }}%</small>
                </div>
              </div>
            </ng-template>
          </p-select>
          @if (generarForm.get('prediccion')?.hasError('required') && generarForm.get('prediccion')?.touched) {
            <small class="p-error">Debe seleccionar una predicción</small>
          }
        </div>

        <div class="flex flex-col mb-4">
          <label for="cantidadAdicional">Cantidad Adicional (opcional)</label>
          <input 
            id="cantidadAdicional" 
            type="number" 
            pInputText 
            formControlName="cantidadAdicional" 
            min="0"
            placeholder="0" />
        </div>

        <div class="flex flex-col mb-4">
          <label for="notasEspeciales">Notas Especiales (opcional)</label>
          <input 
            id="notasEspeciales" 
            type="text" 
            pInputText 
            formControlName="notasEspeciales" 
            placeholder="Notas adicionales..." />
        </div>

        <div class="flex flex-col mb-4">
          <label for="fechaEntregaDeseada">Fecha Entrega Deseada (opcional)</label>
          <input 
            id="fechaEntregaDeseada" 
            type="date" 
            pInputText 
            formControlName="fechaEntregaDeseada" />
        </div>
      </div>
    </form>

    <ng-template #footer>
      <p-button 
        label="Generar Orden" 
        icon="pi pi-check" 
        (onClick)="onSubmit()"
        [disabled]="generarForm.invalid || loading()"
        [loading]="loading()" />
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        (click)="closeDialog()" />
    </ng-template>
  </p-dialog>

  <!-- Búsqueda -->
  <div class="card mb-4">
    <div class="flex justify-between items-center gap-2">
      <p-button 
        [outlined]="true" 
        icon="pi pi-filter-slash" 
        label="Limpiar" 
        (click)="clearSearch()" />
      <p-iconField iconPosition="left">
        <p-inputIcon>
          <i class="pi pi-search"></i>
        </p-inputIcon>
        <input 
          pInputText 
          type="text"
          [value]="searchValue()"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="Buscar órdenes..." />
      </p-iconField>
    </div>
  </div>

  <!-- Tabla de órdenes -->
  <p-table 
    #dt 
    [columns]="cols" 
    [value]="ordenes()" 
    [scrollable]="true" 
    scrollHeight="500px" 
    [tableStyle]="{ 'min-width': '70rem' }"
    [loading]="loading()">
    
    <ng-template #header let-columns>
      <tr>
        @for (col of columns; track col.field) {
          <th>{{ col.header }}</th>
        }
      </tr>
    </ng-template>
    
    <ng-template #body let-rowData let-columns="columns">
      <tr>
        @for (col of columns; track col.field) {
          @if (col.field === 'acciones') {
            <td>
              <div class="flex gap-2">
                <p-button 
                  icon="pi pi-file-pdf" 
                  [rounded]="true" 
                  [text]="true" 
                  severity="info"
                  pTooltip="Descargar PDF"
                  (onClick)="descargarPDF(rowData.ordenCompraId)" />
                
                <p-button 
                  icon="pi pi-eye" 
                  [rounded]="true" 
                  [text]="true" 
                  severity="secondary"
                  pTooltip="Ver PDF"
                  (onClick)="verPDF(rowData.ordenCompraId)" />
                
                @if (rowData.estadoOrden === 'PENDIENTE') {
                  <p-button 
                    icon="pi pi-check" 
                    [rounded]="true" 
                    [text]="true" 
                    severity="success"
                    pTooltip="Confirmar orden"
                    (onClick)="confirmarOrden(rowData)" />
                }
                @if (rowData.estadoOrden === 'ENVIADA' || rowData.estadoOrden === 'APROBADA' || rowData.estadoOrden === 'EN_TRANSITO') {
                  <p-button 
                    icon="pi pi-download" 
                    [rounded]="true" 
                    [text]="true" 
                    severity="success"
                    pTooltip="Marcar recibida"
                    (onClick)="marcarRecibida(rowData)" />
                }
                @if (rowData.estadoOrden === 'PENDIENTE' || rowData.estadoOrden === 'BORRADOR') {
                  <p-button 
                    icon="pi pi-times" 
                    [rounded]="true" 
                    [text]="true" 
                    severity="danger"
                    pTooltip="Cancelar orden"
                    (onClick)="cancelarOrden(rowData)" />
                }
              </div>
            </td>
          } @else if (col.field === 'estadoOrden') {
            <td>
              <p-tag 
                [value]="rowData.estadoOrden" 
                [severity]="getSeverity(rowData.estadoOrden)" />
            </td>
          } @else if (col.field === 'fechaOrden' || col.field === 'fechaEntregaEsperada') {
            <td>{{ formatDate(rowData[col.field]) }}</td>
          } @else if (col.field === 'totalOrden') {
            <td>S/. {{ rowData[col.field]}}</td>
          } @else if (col.field === 'generadaAutomaticamente') {
            <td>
              <i 
                class="pi" 
                [class.pi-check-circle]="rowData.generadaAutomaticamente" 
                [class.pi-times-circle]="!rowData.generadaAutomaticamente"
                [class.text-green-500]="rowData.generadaAutomaticamente"
                [class.text-red-500]="!rowData.generadaAutomaticamente">
              </i>
            </td>
          } @else {
            <td>{{ rowData[col.field] }}</td>
          }
        } @empty {
          <td [attr.colspan]="cols.length" class="text-center py-8">
            <div class="flex flex-col items-center gap-2">
              <i class="pi pi-inbox text-4xl text-gray-400"></i>
              <p class="text-gray-500 m-0">No hay órdenes de compra registradas</p>
            </div>
          </td>
        }
    </ng-template>
  </p-table>

  <!-- Paginación -->
  <div class="card flex justify-center mt-4">
    <p-paginator 
      (onPageChange)="onPageChange($event)" 
      [first]="first()" 
      [rows]="rows()" 
      [totalRecords]="totalRecords()" 
      [rowsPerPageOptions]="rowsPerPageOptions"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}" />
  </div>

  <!-- Toast para mensajes -->
  <p-toast />

  <!-- Dialog de confirmación -->
  <p-confirmDialog />
</div>