<div class="predicciones-container">
  <div class="header-section">
    <h2>Predicciones ARIMA</h2>
    <p-button 
      (click)="showDialog()" 
      label="Generar Predicci贸n" 
      icon="pi pi-chart-line" 
      severity="info" />
  </div>

  <!-- Dialog para generar predicci贸n -->
  <p-dialog 
    [visible]="visible()" 
    (visibleChange)="visible.set($event)" 
    [modal]="true" 
    [style]="{ width: '40rem' }">
    
    <ng-template #header>
      <h3> Generar Nueva Predicci贸n ARIMA</h3>
    </ng-template>
    
    <form [formGroup]="generarForm" (ngSubmit)="onSubmit()">
      <div class="p-fluid">
        <div class="flex flex-col mb-4">
          <label for="producto">Producto *</label>
          <p-select 
            id="producto" 
            [options]="productos()" 
            optionLabel="nombre"
            [showClear]="true"
            [filter]="true"
            filterBy="nombre,categoria.nombre"
            placeholder="Buscar y seleccionar producto..." 
            formControlName="producto"
            [style]="{'width':'100%'}">
            
            <ng-template #selectedItem let-item>
              <div class="flex align-items-center gap-2">
                <span class="font-medium">{{ item.nombre }}</span>
                <small class="text-500">[{{ item.categoria.nombre }}]</small>
              </div>
            </ng-template>
            
            <ng-template #item let-item>
              <div class="flex align-items-center gap-2 p-2">
                <div class="flex flex-col">
                  <span class="font-medium">{{ item.nombre }}</span>
                  <small class="text-500">{{ item.categoria.nombre }} - Stock: {{ item.stock || 0 }}</small>
                </div>
              </div>
            </ng-template>
          </p-select>
          @if (generarForm.get('producto')?.hasError('required') && generarForm.get('producto')?.touched) {
            <small class="p-error">Debe seleccionar un producto</small>
          }
        </div>

        <div class="flex flex-col mb-4">
          <label for="diasPronostico">D铆as a Pronosticar *</label>
          <input 
            id="diasPronostico" 
            type="number"
            pInputText
            formControlName="diasPronostico"
            placeholder="N煤mero de d铆as (ej: 30)"
            min="1"
            max="365" />
          @if (generarForm.get('diasPronostico')?.hasError('required') && generarForm.get('diasPronostico')?.touched) {
            <small class="p-error">Los d铆as de pron贸stico son requeridos</small>
          }
          @if (generarForm.get('diasPronostico')?.hasError('min') && generarForm.get('diasPronostico')?.touched) {
            <small class="p-error">M铆nimo 1 d铆a</small>
          }
          @if (generarForm.get('diasPronostico')?.hasError('max') && generarForm.get('diasPronostico')?.touched) {
            <small class="p-error">M谩ximo 365 d铆as</small>
          }
        </div>

        <div class="flex flex-col mb-4">
          <label for="tipoAnalisis">Tipo de An谩lisis</label>
          <p-select 
            id="tipoAnalisis" 
            [options]="[{label: 'ARIMA', value: 'ARIMA'}, {label: 'SARIMA', value: 'SARIMA'}]" 
            optionLabel="label"
            optionValue="value"
            formControlName="tipoAnalisis"
            placeholder="Seleccionar tipo" />
        </div>
      </div>
    </form>

    <ng-template #footer>
      <p-button 
        label="Generar Predicci贸n" 
        icon="pi pi-check" 
        (onClick)="onSubmit()"
        [disabled]="generarForm.invalid || loading()"
        [loading]="loading()" />
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        (click)="closeDialog()" />
    </ng-template>
  </p-dialog>

  <!-- B煤squeda -->
  <div class="card mb-4">
    <div class="flex justify-between items-center gap-2">
      <p-button 
        [outlined]="true" 
        icon="pi pi-filter-slash" 
        label="Limpiar" 
        (click)="clearSearch()" />
      <p-iconField iconPosition="left">
        <p-inputIcon>
          <i class="pi pi-search"></i>
        </p-inputIcon>
        <input 
          pInputText 
          type="text"
          [value]="searchValue()"
          (input)="onSearchChange($any($event.target).value)"
          placeholder="Buscar predicciones..." />
      </p-iconField>
    </div>
  </div>

  <!-- Tabla de predicciones -->
  <p-table 
    #dt 
    [columns]="cols" 
    [value]="predicciones()" 
    [scrollable]="true" 
    scrollHeight="500px" 
    [tableStyle]="{ 'min-width': '70rem' }"
    [loading]="loading()">
    
    <ng-template #header let-columns>
      <tr>
        @for (col of columns; track col.field) {
          <th>{{ col.header }}</th>
        }
      </tr>
    </ng-template>
    
    <ng-template #body let-rowData let-columns="columns">
      <tr>
        @for (col of columns; track col.field) {
          @if (col.field === 'acciones') {
            <td>
              <div class="flex gap-2">
                <p-button 
                  icon="pi pi-trash" 
                  [rounded]="true" 
                  [text]="true" 
                  severity="danger"
                  pTooltip="Eliminar predicci贸n"
                  (onClick)="eliminarPrediccion(rowData)" />
              </div>
            </td>
          } @else if (col.field === 'producto') {
            <td>{{ rowData.producto.nombre }}</td>
          } @else if (col.field === 'fechaPrediccion' || col.field === 'fechaProyeccion') {
            <td>{{ formatDisplayDate(rowData[col.field]) }}</td>
          } @else if (col.field === 'precision') {
            <td>
              <p-tag 
                [value]="rowData.precision + '%'" 
                [severity]="getSeverity(rowData.precision)" />
            </td>
          } @else {
            <td>{{ rowData[col.field] }}</td>
          }
        } @empty {
          <td [attr.colspan]="cols.length" class="text-center py-8">
            <div class="flex flex-col items-center gap-2">
              <i class="pi pi-chart-line text-4xl text-gray-400"></i>
              <p class="text-gray-500 m-0">No hay predicciones generadas</p>
              <p-button 
                label="Generar Primera Predicci贸n" 
                icon="pi pi-plus"
                severity="info"
                (click)="showDialog()" />
            </div>
          </td>
        }
    </ng-template>
  </p-table>

  <!-- Paginaci贸n -->
  <div class="card flex justify-center mt-4">
    <p-paginator 
      (onPageChange)="onPageChange($event)" 
      [first]="first()" 
      [rows]="rows()" 
      [totalRecords]="totalRecords()" 
      [rowsPerPageOptions]="rowsPerPageOptions" />
  </div>

  <!-- Toast para mensajes -->
  <p-toast />

  <!-- Dialog de confirmaci贸n -->
  <p-confirmDialog />
</div>