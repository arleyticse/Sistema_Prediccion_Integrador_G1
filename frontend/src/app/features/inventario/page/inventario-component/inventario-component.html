<p>Inventario</p>
<div class="mb-4 flex justify-between">
    <p-button 
        (click)="abrirImportacion()" 
        label="Importar CSV" 
        icon="pi pi-upload"
        severity="info"
        [outlined]="true" />
    <p-button (click)="showDialog()" label="Nuevo Inventario" icon="pi pi-plus" />
</div>

<!-- Componente de importación -->
<app-importacion-csv
    #importacionCsv
    endpoint="/importacion/inventario"
    tipoImportacion="Inventario"
    nombrePlantilla="plantilla_inventario.csv"
    (importacionCompletada)="cargarInventarios()" />

<!-- Dialog para crear/editar inventario -->
<p-dialog [visible]="visible()" (visibleChange)="visible.set($event)" [modal]="true" [style]="{ width: '30rem' }">
    <ng-template #header>
        <h2>{{ isEditing() ? 'Editar Inventario' : 'Nuevo Inventario' }}</h2>
    </ng-template>

    <form [formGroup]="inventarioForm" (ngSubmit)="onSubmit()">
        <div class="p-fluid">
            <!-- Select de Productos con búsqueda y virtual scroll -->
            <div class="flex flex-col mb-4">
                <label for="producto">Producto</label>
                <p-select 
                    id="producto"
                    [options]="productos()"
                    formControlName="producto"
                    optionLabel="nombre"
                    placeholder="Buscar producto..."
                    [filter]="true"
                    filterBy="nombre"
                    [showClear]="true"
                    [virtualScroll]="true"
                    [virtualScrollItemSize]="38"
                    [loading]="loadingProductos()">
                    <ng-template #selectedItem let-option>
                        @if (option) {
                            <div class="flex flex-col gap-1">
                                <span class="font-semibold">{{ option.nombre }}</span>
                                <span class="text-sm text-gray-500">{{ option.categoria.nombre }}</span>
                            </div>
                        }
                    </ng-template>
                    <ng-template let-product #item>
                        <div class="flex flex-col gap-1">
                            <span class="font-semibold">{{ product.nombre }}</span>
                            <span class="text-sm text-gray-500">{{ product.categoria.nombre }}</span>
                        </div>
                    </ng-template>
                </p-select>
                @if (inventarioForm.get('producto')?.hasError('required') && inventarioForm.get('producto')?.touched) {
                    <small class="p-error">El producto es requerido</small>
                }
            </div>

            <!-- Stock Disponible -->
            <div class="flex flex-col mb-4">
                <label for="stockDisponible">Stock Disponible</label>
                <p-inputNumber 
                    id="stockDisponible"
                    formControlName="stockDisponible"
                    [min]="0"
                    placeholder="Cantidad disponible" />
                @if (inventarioForm.get('stockDisponible')?.hasError('required') && inventarioForm.get('stockDisponible')?.touched) {
                    <small class="p-error">Stock disponible requerido</small>
                }
            </div>

            <!-- Stock Reservado -->
            <div class="flex flex-col mb-4">
                <label for="stockReservado">Stock Reservado</label>
                <p-inputNumber 
                    id="stockReservado"
                    formControlName="stockReservado"
                    [min]="0"
                    placeholder="Cantidad reservada" />
            </div>

            <!-- Stock En Tránsito -->
            <div class="flex flex-col mb-4">
                <label for="stockEnTransito">Stock En Tránsito</label>
                <p-inputNumber 
                    id="stockEnTransito"
                    formControlName="stockEnTransito"
                    [min]="0"
                    placeholder="Cantidad en tránsito" />
            </div>

            <!-- Stock Mínimo -->
            <div class="flex flex-col mb-4">
                <label for="stockMinimo">Stock Mínimo</label>
                <p-inputNumber 
                    id="stockMinimo"
                    formControlName="stockMinimo"
                    [min]="0"
                    placeholder="Cantidad mínima" />
                @if (inventarioForm.get('stockMinimo')?.hasError('required') && inventarioForm.get('stockMinimo')?.touched) {
                    <small class="p-error">Stock mínimo requerido</small>
                }
            </div>

            <!-- Stock Máximo -->
            <div class="flex flex-col mb-4">
                <label for="stockMaximo">Stock Máximo</label>
                <p-inputNumber 
                    id="stockMaximo"
                    formControlName="stockMaximo"
                    [min]="0"
                    placeholder="Cantidad máxima" />
            </div>

            <!-- Punto de Reorden -->
            <div class="flex flex-col mb-4">
                <label for="puntoReorden">Punto de Reorden</label>
                <p-inputNumber 
                    id="puntoReorden"
                    formControlName="puntoReorden"
                    [min]="0"
                    placeholder="Punto de reorden" />
                @if (inventarioForm.get('puntoReorden')?.hasError('required') && inventarioForm.get('puntoReorden')?.touched) {
                    <small class="p-error">Punto de reorden requerido</small>
                }
            </div>

            <!-- Ubicación Almacén -->
            <div class="flex flex-col mb-4">
                <label for="ubicacion">Ubicación Almacén</label>
                <input 
                    id="ubicacion"
                    type="text" 
                    pInputText 
                    formControlName="ubicacionAlmacen"
                    placeholder="Ej: Pasillo A, Estante 3" />
            </div>

            <!-- Observaciones -->
            <div class="flex flex-col mb-4">
                <label for="observaciones">Observaciones</label>
                <textarea 
                    id="observaciones"
                    pInputTextarea
                    formControlName="observaciones"
                    [rows]="3"
                    placeholder="Notas adicionales..."></textarea>
            </div>
        </div>
    </form>

    <ng-template #footer>
        <p-button 
            [label]="isEditing() ? 'Actualizar' : 'Guardar'" 
            icon="pi pi-check" 
            (onClick)="onSubmit()"
            [disabled]="inventarioForm.invalid" />
        <p-button 
            label="Cancelar" 
            icon="pi pi-times" 
            severity="danger"
            (click)="closeDialog()" />
    </ng-template>
</p-dialog>

<!-- Tabla de Inventarios -->
<p-table 
    [columns]="cols" 
    [value]="inventarios()" 
    [tableStyle]="{ 'min-width': '50rem' }" [loading]="loading()">
    <ng-template #header let-columns>
        <tr>
            @for (col of columns; track col.field) {
                <th>{{ col.header }}</th>
            }
        </tr>
    </ng-template>
    <ng-template #body let-inventario let-columns="columns">
        <tr>
            @for (col of columns; track col.field) {
                @if (col.field === 'acciones') {
                    <td>
                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" label="Editar" severity="info" (onClick)="editar(inventario)" />
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" label="Eliminar" severity="danger" (onClick)="eliminar(inventario)" />
                    </td>
                } @else if (col.field === 'producto') {
                    <td>{{ inventario.nombreProducto }}</td>
                } @else {
                    <td>{{ inventario[col.field] }}</td>
                }
            }
            @empty {
                <td [attr.colspan]="cols.length" class="text-center py-4">
                    <p class="text-gray-500">No hay inventarios registrados</p>
                </td>
            }
        </tr>
    </ng-template>
</p-table>

<!-- Paginador -->
<div class="card flex justify-center mt-4">
    <p-paginator 
        (onPageChange)="onPageChange($event)" 
        [first]="first()" 
        [rows]="rows()" 
        [totalRecords]="totalRecords()" 
        [rowsPerPageOptions]="rowsPerPageOptions" />
</div>

<p-confirmDialog />