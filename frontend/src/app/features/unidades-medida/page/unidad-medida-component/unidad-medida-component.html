<div class="mb-4 flex justify-end">
    <p-button (click)="showDialog()" label="Nueva Unidad de Medida" icon="pi pi-plus" />
</div>

<!-- Dialog modal no draggable -->
<p-dialog [visible]="visible()" (visibleChange)="visible.set($event)" [modal]="true" [draggable]="false"
    [style]="{ width: '35rem' }" [contentStyle]="{ 'padding': '1.25rem', 'overflow': 'visible' }">
    <ng-template #header>
        <h2 class="text-3xl">{{ isEditing() ? 'Editar Unidad de Medida' : 'Nueva Unidad de Medida' }}</h2>
    </ng-template>

    <form [formGroup]="unidadForm" (ngSubmit)="onSubmit()" class="py-2">
        <div class="space-y-4">
            <!-- Nombre y Abreviatura en 2 columnas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="field">
                    <p-floatlabel>
                        <input pInputText id="nombre" formControlName="nombre" [pKeyFilter]="keyFilterPatternName" [pValidateOnly]="true" class="w-full" />
                        <label for="nombre">Nombre</label>
                    </p-floatlabel>
                    @if (unidadForm.get('nombre')?.hasError('required') && unidadForm.get('nombre')?.touched) {
                    <p-message severity="error" variant="simple" size="small">El nombre es requerido</p-message>
                    }
                    @if (unidadForm.get('nombre')?.hasError('pattern') && unidadForm.get('nombre')?.touched) {
                    <p-message severity="error" variant="simple" size="small">El nombre sólo puede contener letras y espacios</p-message>
                    }
                </div>

                <div class="field">
                    <p-floatlabel>
                        <input pInputText id="abreviatura" formControlName="abreviatura" [pKeyFilter]="keyFilterPatternAbbrev" [pValidateOnly]="true"
                            class="w-full" />
                        <label for="abreviatura">Abreviatura</label>
                    </p-floatlabel>
                    @if (unidadForm.get('abreviatura')?.hasError('required') && unidadForm.get('abreviatura')?.touched)
                    {
                    <p-message severity="error" variant="simple" size="small">La abreviatura es requerida</p-message>
                    }
                    @if (unidadForm.get('abreviatura')?.hasError('maxlength') && unidadForm.get('abreviatura')?.touched)
                    {
                    <p-message severity="error" variant="simple" size="small">Máximo 5 caracteres</p-message>
                    }
                </div>
            </div>
        </div>
    </form>

    <ng-template #footer>
        <p-button [label]="isEditing() ? 'Actualizar' : 'Guardar'" icon="pi pi-check" (onClick)="onSubmit()"
            [disabled]="unidadForm.invalid" />
        <p-button label="Cancelar" icon="pi pi-times" severity="danger" (click)="closeDialog()" />
    </ng-template>
</p-dialog>

<p-toast />
<!-- Tabla de Unidades de Medida -->
<div class="card">
    @if (loading()) {
    <!-- Skeleton Loading State -->
    <div class="space-y-3">
        <p-skeleton height="3rem" class="mb-3"></p-skeleton>
        @for (item of [1,2,3,4,5]; track item) {
        <div class="flex gap-3">
            <p-skeleton width="10%" height="2.5rem"></p-skeleton>
            <p-skeleton width="40%" height="2.5rem"></p-skeleton>
            <p-skeleton width="30%" height="2.5rem"></p-skeleton>
            <p-skeleton width="20%" height="2.5rem"></p-skeleton>
        </div>
        }
    </div>
    } @else {
    <p-table [columns]="cols" [value]="unidadMedidas()" [scrollable]="true" scrollHeight="400px"
        [tableStyle]="{ 'min-width': '50rem' }">
        <ng-template #header let-columns>
            <tr>
                @for (col of columns; track col.field) {
                <th>{{ col.header }}</th>
                }
            </tr>
        </ng-template>
        <ng-template #body let-rowData let-columns="columns">
            <tr>
                @for (col of columns; track col.field) {
                @if (col.field === 'acciones') {
                <td>
                    <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" label="" severity="info"
                        (onClick)="editar(rowData)" pTooltip="Editar" tooltipPosition="top" />
                    <p-button icon="pi pi-trash" [rounded]="true" [text]="true" label="" severity="danger"
                        (onClick)="eliminar(rowData)" pTooltip="Eliminar" tooltipPosition="top" />
                </td>
                } @else {
                <td>{{ rowData[col.field] }}</td>
                }
                }@empty {
                <td [attr.colspan]="cols.length" class="text-center py-4">
                    <p class="text-gray-500">No hay unidades de medida registradas</p>
                </td>
                }
            </tr>
        </ng-template>
    </p-table>
    }
</div>
<p-confirmDialog />