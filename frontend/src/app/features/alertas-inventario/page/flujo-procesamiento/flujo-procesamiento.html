<p-toast></p-toast>

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-6">
	<!-- Header Section -->
	<div class="mb-6">
		<h1 class="text-3xl font-bold text-slate-800 mb-2">Flujo de Procesamiento de Alertas</h1>
		<p class="text-slate-600">Gestión automatizada de predicciones y órdenes de compra usando SMILE ML</p>
	</div>

	<!-- Steps Progress -->
	<div class="bg-white rounded-xl shadow-sm p-6 mb-6">
		<p-steps [model]="pasos" [activeIndex]="pasoActual()" [readonly]="true"></p-steps>
	</div>

	<!-- Loader -->
	@if (cargando()) {
		<div class="flex flex-col items-center justify-center py-16">
			<i class="pi pi-spin pi-spinner text-5xl text-blue-500 mb-4"></i>
			<p class="text-lg text-slate-600 font-medium">Procesando predicciones</p>
			<p class="text-sm text-slate-500 mt-2">Esto puede tardar unos momentos</p>
		</div>
	}

	<!-- Paso 0: Selección de Alertas -->
	@if (!cargando() && pasoActual() === 0) {
		<div class="space-y-6">
			<!-- Control Panel -->
			<div class="bg-white rounded-xl shadow-sm p-6">
				<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
					<div>
						<h2 class="text-2xl font-bold text-slate-800 mb-1">Selecciona Alertas por Proveedor</h2>
						<p class="text-sm text-slate-600">Selecciona las alertas que deseas procesar para generar predicciones</p>
					</div>
					
					<div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
						<div class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-lg border border-slate-200">
							<i class="pi pi-calendar text-slate-600"></i>
							<label class="text-sm font-medium text-slate-700">Horizonte:</label>
							<p-inputNumber 
								[ngModel]="horizontePrediccion()" 
								[min]="7" 
								[max]="365" 
								inputId="hor" 
								(ngModelChange)="horizontePrediccion.set($event)" 
								[showButtons]="true"
								[step]="7"
								suffix=" días"
								class="w-32">
							</p-inputNumber>
						</div>
						<button 
							pButton 
							type="button" 
							icon="pi pi-chart-line" 
							label="Generar Predicciones"
							class="p-button-primary px-6 py-3 font-semibold whitespace-nowrap" 
							(click)="irAPasoPredicciones()"
							[disabled]="totalSeleccionadas() === 0">
						</button>
					</div>
				</div>

				<!-- Summary Cards -->
				<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
					<div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-medium text-blue-700 uppercase mb-1">Alertas Seleccionadas</p>
								<p class="text-3xl font-bold text-blue-900">{{ totalSeleccionadas() }}</p>
							</div>
							<i class="pi pi-check-circle text-4xl text-blue-500 opacity-50"></i>
						</div>
					</div>
					<div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-lg border border-emerald-200">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-medium text-emerald-700 uppercase mb-1">Productos</p>
								<p class="text-3xl font-bold text-emerald-900">{{ totalProductosSeleccionados() }}</p>
							</div>
							<i class="pi pi-box text-4xl text-emerald-500 opacity-50"></i>
						</div>
					</div>
					<div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-medium text-purple-700 uppercase mb-1">Costo Estimado</p>
								<p class="text-3xl font-bold text-purple-900">S/ {{ totalEstimado() | number:'1.0-2' }}</p>
							</div>
							<i class="pi pi-dollar text-4xl text-purple-500 opacity-50"></i>
						</div>
					</div>
				</div>
			</div>

			<!-- Proveedores Section -->
			@for (g of grupos(); track g.proveedorId) {
				<div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow">
					<div class="bg-gradient-to-r from-slate-700 to-slate-600 p-5">
						<div class="flex items-center justify-between">
							<div class="flex items-center gap-3">
								<p-checkbox 
									binary="true" 
									inputId="sel-{{g.proveedorId}}"
									(onChange)="toggleSeleccionProveedor(g.proveedorId, $event.checked)"
									class="scale-125">
								</p-checkbox>
								<div>
									<h3 class="text-xl font-bold text-white">{{ g.proveedorNombre }}</h3>
									<p class="text-sm text-slate-300 mt-1">
										<i class="pi pi-exclamation-circle mr-1"></i>
										{{ g.totalAlertas }} alertas activas
									</p>
								</div>
							</div>
							<div class="text-right">
								<p class="text-xs text-slate-300 uppercase mb-1">Cantidad Total Sugerida</p>
								<p class="text-2xl font-bold text-white">{{ g.cantidadTotalSugerida }}</p>
							</div>
						</div>
					</div>

					<div class="p-5">
						<p-table 
							[value]="g.alertas" 
							[tableStyle]="{ 'min-width': '60rem' }" 
							responsiveLayout="scroll"
							styleClass="p-datatable-sm p-datatable-striped">
							<ng-template pTemplate="header">
								<tr class="bg-slate-50">
									<th class="w-14 text-center">
										<i class="pi pi-check text-slate-600"></i>
									</th>
									<th class="font-semibold text-slate-700">
										<i class="pi pi-barcode mr-2"></i>SKU
									</th>
									<th class="font-semibold text-slate-700">
										<i class="pi pi-box mr-2"></i>Producto
									</th>
									<th class="text-right font-semibold text-slate-700">
										<i class="pi pi-database mr-2"></i>Stock
									</th>
									<th class="text-right font-semibold text-slate-700">
										<i class="pi pi-flag mr-2"></i>Punto ROP
									</th>
									<th class="text-right font-semibold text-slate-700">
										<i class="pi pi-shopping-cart mr-2"></i>Sugerido
									</th>
									<th class="text-right font-semibold text-slate-700">
										<i class="pi pi-money-bill mr-2"></i>Costo Unit.
									</th>
									<th class="text-center font-semibold text-slate-700">
										<i class="pi pi-exclamation-triangle mr-2"></i>Criticidad
									</th>
								</tr>
							</ng-template>
							<ng-template pTemplate="body" let-a>
								<tr class="hover:bg-slate-50 transition-colors">
									<td class="text-center">
										<p-checkbox 
											[binary]="true" 
											[ngModel]="seleccion().has(a.alertaId)"
											(onChange)="toggleSeleccion(a.alertaId, $event.checked)">
										</p-checkbox>
									</td>
									<td>
										<span class="font-mono font-semibold text-blue-600">
											{{ a.producto.codigoSKU || '-' }}
										</span>
									</td>
									<td>
										<span class="font-medium text-slate-800">{{ a.producto.nombre }}</span>
									</td>
									<td class="text-right">
										<span class="font-medium" [class]="(a.stockActual ?? 0) < (a.stockMinimo ?? 0) ? 'text-red-600' : 'text-slate-700'">
											{{ a.stockActual ?? '-' }}
										</span>
									</td>
									<td class="text-right">
										<span class="text-slate-600">{{ a.stockMinimo ?? '-' }}</span>
									</td>
									<td class="text-right">
										<span class="font-bold text-emerald-600 text-lg">{{ a.cantidadSugerida ?? 0 }}</span>
									</td>
									<td class="text-right">
										<span class="text-slate-700">S/ {{ (a.costoAdquisicion ?? 0) | number:'1.2-2' }}</span>
									</td>
									<td class="text-center">
										<p-tag 
											[value]="a.nivelCriticidad" 
											[severity]="a.nivelCriticidad === 'ALTA' ? 'danger' : (a.nivelCriticidad === 'MEDIA' ? 'warn' : 'success')"
											[rounded]="true">
										</p-tag>
									</td>
								</tr>
							</ng-template>
							<ng-template pTemplate="emptymessage">
								<tr>
									<td colspan="8" class="text-center py-8 text-slate-500">
										<i class="pi pi-inbox text-4xl mb-3 block"></i>
										<p>No hay alertas disponibles para este proveedor</p>
									</td>
								</tr>
							</ng-template>
						</p-table>
					</div>
				</div>
			}

			<!-- Action Footer -->
			<div class="bg-white rounded-xl shadow-sm p-6">
				<div class="flex flex-col sm:flex-row items-center justify-between gap-4">
					<div class="text-slate-600">
						<p class="text-sm">
							<span class="font-semibold text-slate-800 text-lg">{{ totalSeleccionadas() }}</span> alertas seleccionadas
							<span class="mx-2">•</span>
							Inversión estimada: <span class="font-bold text-purple-600 text-lg">S/ {{ totalEstimado() | number:'1.0-2' }}</span>
						</p>
					</div>
					<button 
						pButton 
						type="button" 
						icon="pi pi-arrow-right" 
						label="Generar Predicciones"
						class="p-button-primary p-button-lg px-8 font-semibold" 
						(click)="irAPasoPredicciones()"
						[disabled]="totalSeleccionadas() === 0">
					</button>
				</div>
			</div>
		</div>
	}

	<!-- Paso 1: Ver Predicciones -->
	@if (!cargando() && pasoActual() === 1) {
		<div class="space-y-6">
			<!-- Header con Action -->
			<div class="bg-white rounded-xl shadow-sm p-6">
				<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
					<div>
						<h2 class="text-2xl font-bold text-slate-800 mb-1">
							<i class="pi pi-chart-line text-emerald-500 mr-2"></i>
							Predicciones Generadas con SMILE ML
						</h2>
						<p class="text-sm text-slate-600">
							Algoritmos de Machine Learning: Random Forest, Gradient Boosting, OLS
						</p>
					</div>
					<div class="flex gap-3">
						<button 
							pButton 
							type="button" 
							icon="pi pi-arrow-left" 
							label="Volver" 
							class="p-button-outlined p-button-secondary"
							(click)="pasoActual.set(0)">
						</button>
						<button 
							pButton 
							type="button" 
							icon="pi pi-shopping-cart" 
							label="Generar Órdenes"
							class="p-button-success p-button-lg px-6 font-semibold" 
							(click)="generarOrdenes()">
						</button>
					</div>
				</div>
			</div>

			<!-- Predicciones por Proveedor -->
			@for (proveedorEntry of prediccionesPorProveedor() | keyvalue; track proveedorEntry.key) {
				<div class="bg-white rounded-xl shadow-sm overflow-hidden">
					<!-- Proveedor Header -->
					<div class="bg-gradient-to-r from-emerald-600 to-emerald-500 p-6">
						<div class="flex items-start justify-between">
							<div class="flex-1">
								<h3 class="text-2xl font-bold text-white mb-2">
									<i class="pi pi-building mr-2"></i>
									{{ proveedorEntry.value.nombreProveedor }}
								</h3>
								<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-emerald-50">
									<div class="flex items-center gap-2">
										<i class="pi pi-id-card"></i>
										<span>RUC: {{ proveedorEntry.value.rucProveedor }}</span>
									</div>
									<div class="flex items-center gap-2">
										<i class="pi pi-phone"></i>
										<span>{{ proveedorEntry.value.telefonoProveedor || 'N/A' }}</span>
									</div>
									<div class="flex items-center gap-2">
										<i class="pi pi-envelope"></i>
										<span class="truncate">{{ proveedorEntry.value.emailProveedor || 'N/A' }}</span>
									</div>
								</div>
							</div>
							<div class="text-right">
								<p class="text-emerald-100 text-xs uppercase mb-1">Predicciones</p>
								<p class="text-3xl font-bold text-white">{{ proveedorEntry.value.prediccionesExitosas }}</p>
							</div>
						</div>
					</div>

					<div class="p-6">
						<!-- Métricas Agregadas -->
						@if (proveedorEntry.value.metricas) {
							<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
								<div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
									<div class="flex items-center gap-2 mb-2">
										<i class="pi pi-chart-bar text-blue-600"></i>
										<p class="text-xs font-semibold text-blue-700 uppercase">MAPE Promedio</p>
									</div>
									<p class="text-2xl font-bold text-blue-900">
										{{ proveedorEntry.value.metricas.mapePromedio | number:'1.1-1' }}%
									</p>
								</div>
								
								<div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-lg border border-emerald-200">
									<div class="flex items-center gap-2 mb-2">
										<i class="pi pi-check-circle text-emerald-600"></i>
										<p class="text-xs font-semibold text-emerald-700 uppercase">Calidad</p>
									</div>
									<p class="text-2xl font-bold text-emerald-900">
										{{ proveedorEntry.value.metricas.calidadGeneral }}
									</p>
								</div>
								
								<div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
									<div class="flex items-center gap-2 mb-2">
										<i class="pi pi-percentage text-purple-600"></i>
										<p class="text-xs font-semibold text-purple-700 uppercase">Aceptables</p>
									</div>
									<p class="text-2xl font-bold text-purple-900">
										{{ proveedorEntry.value.metricas.porcentajeAceptable | number:'1.0-0' }}%
									</p>
								</div>
								
								<div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
									<div class="flex items-center gap-2 mb-2">
										<i class="pi pi-box text-amber-600"></i>
										<p class="text-xs font-semibold text-amber-700 uppercase">Productos</p>
									</div>
									<p class="text-2xl font-bold text-amber-900">
										{{ proveedorEntry.value.metricas.totalProductos }}
									</p>
								</div>
								
								<div class="bg-gradient-to-br from-rose-50 to-rose-100 p-4 rounded-lg border border-rose-200">
									<div class="flex items-center gap-2 mb-2">
										<i class="pi pi-exclamation-triangle text-rose-600"></i>
										<p class="text-xs font-semibold text-rose-700 uppercase">MAE Prom.</p>
									</div>
									<p class="text-2xl font-bold text-rose-900">
										{{ proveedorEntry.value.metricas.maePromedio | number:'1.1-1' }}
									</p>
								</div>
							</div>

							<!-- Distribución de Calidad -->
							<div class="grid grid-cols-4 gap-3 mb-6 p-4 bg-slate-50 rounded-lg">
								<div class="text-center">
									<p class="text-xs text-slate-600 mb-1">Excelentes</p>
									<p class="text-xl font-bold text-emerald-600">
										{{ proveedorEntry.value.metricas.prediccionesExcelentes }}
									</p>
								</div>
								<div class="text-center">
									<p class="text-xs text-slate-600 mb-1">Buenas</p>
									<p class="text-xl font-bold text-blue-600">
										{{ proveedorEntry.value.metricas.prediccionesBuenas }}
									</p>
								</div>
								<div class="text-center">
									<p class="text-xs text-slate-600 mb-1">Regulares</p>
									<p class="text-xl font-bold text-amber-600">
										{{ proveedorEntry.value.metricas.prediccionesRegulares }}
									</p>
								</div>
								<div class="text-center">
									<p class="text-xs text-slate-600 mb-1">Malas</p>
									<p class="text-xl font-bold text-red-600">
										{{ proveedorEntry.value.metricas.prediccionesMalas }}
									</p>
								</div>
							</div>
						}

						<!-- Tabla de Predicciones -->
						<p-table 
							[value]="proveedorEntry.value.predicciones" 
							[tableStyle]="{ 'min-width': '60rem' }"
							styleClass="p-datatable-sm p-datatable-striped">
							<ng-template pTemplate="header">
								<tr class="bg-slate-50">
									<th class="font-semibold text-slate-700">
										<i class="pi pi-barcode mr-2"></i>SKU
									</th>
									<th class="font-semibold text-slate-700">
										<i class="pi pi-box mr-2"></i>Producto
									</th>
									<th class="font-semibold text-slate-700">
										<i class="pi pi-cog mr-2"></i>Algoritmo
									</th>
									<th class="text-center font-semibold text-slate-700">
										<i class="pi pi-star mr-2"></i>Calidad
									</th>
									<th class="text-right font-semibold text-slate-700">MAPE</th>
									<th class="text-right font-semibold text-slate-700">MAE</th>
									<th class="text-right font-semibold text-slate-700">EOQ</th>
									<th class="text-right font-semibold text-slate-700">ROP</th>
									<th class="text-center font-semibold text-slate-700">Acciones</th>
								</tr>
							</ng-template>
							<ng-template pTemplate="body" let-pred>
								<tr class="hover:bg-slate-50 transition-colors">
									<td>
										<span class="font-mono font-semibold text-blue-600">
											{{ pred.codigoSKU || pred.codigoProducto || '-' }}
										</span>
									</td>
									<td>
										<span class="font-medium text-slate-800">{{ pred.nombreProducto }}</span>
									</td>
									<td>
										<p-tag 
											[value]="pred.algoritmoUsado" 
											[severity]="pred.algoritmoUsado === 'RANDOM_FOREST' ? 'success' : 
											           (pred.algoritmoUsado === 'GRADIENT_BOOSTING' ? 'info' : 'secondary')"
											[rounded]="true">
										</p-tag>
									</td>
									<td class="text-center">
										<p-tag 
											[value]="pred.calidadPrediccion" 
											[severity]="getSeverityCalidad(pred.calidadPrediccion)"
											[rounded]="true">
										</p-tag>
									</td>
									<td class="text-right">
										<span class="font-semibold" [class]="pred.mape < 20 ? 'text-emerald-600' : 
										                                     (pred.mape < 50 ? 'text-amber-600' : 'text-red-600')">
											{{ pred.mape | number:'1.1-1' }}%
										</span>
									</td>
									<td class="text-right text-slate-700">{{ pred.mae | number:'1.1-1' }}</td>
									<td class="text-right">
										<span class="font-bold text-blue-600">{{ pred.cantidadOptimaPedido }}</span>
									</td>
									<td class="text-right">
										<span class="font-bold text-purple-600">{{ pred.puntoReorden }}</span>
									</td>
									<td class="text-center">
										<button 
											pButton 
											type="button" 
											icon="pi pi-chart-line" 
											label="Ver Gráfico" 
											class="p-button-sm p-button-outlined p-button-info"
											(click)="verDetallePrediccion(pred)">
										</button>
									</td>
								</tr>
							</ng-template>
						</p-table>
					</div>
				</div>
			}

			<!-- Action Footer -->
			<div class="bg-white rounded-xl shadow-sm p-6">
				<div class="flex flex-col sm:flex-row items-center justify-between gap-4">
					<button 
						pButton 
						type="button" 
						icon="pi pi-arrow-left" 
						label="Volver a Selección" 
						class="p-button-outlined p-button-secondary"
						(click)="pasoActual.set(0)">
					</button>
					<button 
						pButton 
						type="button" 
						icon="pi pi-shopping-cart" 
						label="Generar Órdenes de Compra"
						class="p-button-success p-button-lg px-8 font-semibold" 
						(click)="generarOrdenes()">
					</button>
				</div>
			</div>
		</div>
	}

	<!-- Paso 2: Órdenes Generadas -->
	@if (pasoActual() === 2 && procesamientoResultado()) {
		<div class="space-y-6">
			<!-- Success Header -->
			<div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl shadow-lg p-8 text-white">
				<div class="flex items-center gap-4 mb-4">
					<div class="bg-white rounded-full p-4">
						<i class="pi pi-check text-4xl text-emerald-600"></i>
					</div>
					<div>
						<h2 class="text-3xl font-bold">¡Proceso Completado Exitosamente!</h2>
						<p class="text-emerald-100 mt-1">Órdenes de compra generadas automáticamente</p>
					</div>
				</div>
			</div>

			<!-- Estadísticas del Procesamiento -->
			<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
				<div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
					<div class="flex items-center justify-between mb-3">
						<i class="pi pi-inbox text-3xl text-blue-500"></i>
						<p class="text-xs font-semibold text-slate-600 uppercase">Total Procesadas</p>
					</div>
					<p class="text-4xl font-bold text-slate-800">{{ procesamientoResultado()!.totalProcesadas }}</p>
					<p class="text-sm text-slate-600 mt-2">Alertas procesadas</p>
				</div>

				<div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-emerald-500">
					<div class="flex items-center justify-between mb-3">
						<i class="pi pi-check-circle text-3xl text-emerald-500"></i>
						<p class="text-xs font-semibold text-slate-600 uppercase">Exitosas</p>
					</div>
					<p class="text-4xl font-bold text-emerald-600">{{ procesamientoResultado()!.exitosos }}</p>
					<p class="text-sm text-slate-600 mt-2">Predicciones correctas</p>
				</div>

				<div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
					<div class="flex items-center justify-between mb-3">
						<i class="pi pi-shopping-cart text-3xl text-purple-500"></i>
						<p class="text-xs font-semibold text-slate-600 uppercase">Órdenes</p>
					</div>
					<p class="text-4xl font-bold text-purple-600">{{ procesamientoResultado()!.ordenesGeneradas.length }}</p>
					<p class="text-sm text-slate-600 mt-2">Órdenes generadas</p>
				</div>

				<div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-amber-500">
					<div class="flex items-center justify-between mb-3">
						<i class="pi pi-exclamation-triangle text-3xl text-amber-500"></i>
						<p class="text-xs font-semibold text-slate-600 uppercase">Fallos</p>
					</div>
					<p class="text-4xl font-bold text-amber-600">
						{{ procesamientoResultado()!.totalProcesadas - procesamientoResultado()!.exitosos }}
					</p>
					<p class="text-sm text-slate-600 mt-2">Predicciones fallidas</p>
				</div>
			</div>

			<!-- Detalles de Órdenes -->
			<div class="bg-white rounded-xl shadow-sm overflow-hidden">
				<div class="bg-gradient-to-r from-slate-700 to-slate-600 p-6">
					<h3 class="text-2xl font-bold text-white">
						<i class="pi pi-list mr-2"></i>
						Órdenes de Compra Generadas
					</h3>
					<p class="text-slate-300 mt-1">Resumen de las órdenes creadas automáticamente</p>
				</div>

				<div class="p-6">
					@if (procesamientoResultado()!.ordenesGeneradas.length > 0) {
						<div class="bg-emerald-50 border border-emerald-200 rounded-lg p-6 text-center">
							<i class="pi pi-check-circle text-6xl text-emerald-600 mb-4 block"></i>
							<h4 class="text-2xl font-bold text-emerald-800 mb-2">
								{{ procesamientoResultado()!.ordenesGeneradas.length }} Órdenes Generadas
							</h4>
							<p class="text-emerald-700 mb-6">
								Las órdenes de compra han sido creadas automáticamente y están listas para revisión
							</p>
							<div class="flex flex-wrap gap-2 justify-center">
								@for (ordenId of procesamientoResultado()!.ordenesGeneradas; track ordenId) {
									<p-tag 
										[value]="'Orden #' + ordenId" 
										severity="success"
										[rounded]="true"
										styleClass="px-4 py-2 text-base font-semibold">
									</p-tag>
								}
							</div>
						</div>
					} @else {
						<div class="text-center py-12">
							<i class="pi pi-inbox text-6xl text-slate-300 mb-4 block"></i>
							<p class="text-slate-500 text-lg">No se generaron órdenes en este procesamiento</p>
						</div>
					}
				</div>
			</div>

			<!-- Actions -->
			<div class="flex flex-col sm:flex-row gap-4 justify-center">
				<button 
					pButton 
					type="button" 
					icon="pi pi-list" 
					label="Ver Todas las Órdenes" 
					class="p-button-info p-button-lg px-8"
					(click)="verOrdenes()">
				</button>
				<button 
					pButton 
					type="button" 
					icon="pi pi-refresh" 
					label="Iniciar Nuevo Flujo" 
					class="p-button-primary p-button-lg px-8"
					(click)="iniciarNuevo()">
				</button>
			</div>
		</div>
	}

	<!-- Diálogo de detalle de predicción -->
	<p-dialog 
		[(visible)]="mostrarDetallePrediccion" 
		[modal]="true" 
		[style]="{width: '95vw', maxWidth: '1200px'}"
		[draggable]="false"
		[resizable]="false"
		styleClass="custom-dialog">
		
		<ng-template pTemplate="header">
			@if (prediccionSeleccionada()) {
				<div class="flex items-center gap-3">
					<i class="pi pi-chart-line text-3xl text-blue-600"></i>
					<div>
						<h3 class="text-2xl font-bold text-slate-800">
							{{ prediccionSeleccionada()!.nombreProducto }}
						</h3>
						<p class="text-sm text-slate-600 mt-1">
							SKU: {{ prediccionSeleccionada()!.codigoSKU || prediccionSeleccionada()!.codigoProducto || 'N/A' }}
						</p>
					</div>
				</div>
			}
		</ng-template>
		
		@if (prediccionSeleccionada()) {
			<div class="space-y-6 -m-6 p-6 bg-slate-50">
				<!-- Info Básica -->
				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div class="bg-white p-4 rounded-lg shadow-sm">
						<p class="text-xs text-slate-600 mb-1 flex items-center gap-1">
							<i class="pi pi-cog"></i> Algoritmo
						</p>
						<p-tag 
							[value]="prediccionSeleccionada()!.algoritmoUsado" 
							[severity]="prediccionSeleccionada()!.algoritmoUsado === 'RANDOM_FOREST' ? 'success' : 'info'"
							[rounded]="true">
						</p-tag>
					</div>
					<div class="bg-white p-4 rounded-lg shadow-sm">
						<p class="text-xs text-slate-600 mb-1 flex items-center gap-1">
							<i class="pi pi-calendar"></i> Horizonte
						</p>
						<p class="text-xl font-bold text-slate-800">
							{{ prediccionSeleccionada()!.horizonteUsado }} días
						</p>
					</div>
					<div class="bg-white p-4 rounded-lg shadow-sm">
						<p class="text-xs text-slate-600 mb-1 flex items-center gap-1">
							<i class="pi pi-database"></i> Datos Históricos
						</p>
						<p class="text-xl font-bold text-blue-600">
							{{ prediccionSeleccionada()!.valoresHistoricos.length }} registros
						</p>
					</div>
					<div class="bg-white p-4 rounded-lg shadow-sm">
						<p class="text-xs text-slate-600 mb-1 flex items-center gap-1">
							<i class="pi pi-chart-line"></i> Predicciones
						</p>
						<p class="text-xl font-bold text-emerald-600">
							{{ prediccionSeleccionada()!.valoresPredichos.length }} valores
						</p>
					</div>
				</div>

				<!-- Métricas de Calidad -->
				<div class="bg-white rounded-xl shadow-sm p-6">
					<h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
						<i class="pi pi-star-fill text-amber-500"></i>
						Métricas de Calidad
					</h4>
					<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
						<div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
							<p class="text-xs font-semibold text-blue-700 uppercase mb-1">MAPE</p>
							<p class="text-3xl font-bold text-blue-900">
								{{ prediccionSeleccionada()!.mape | number:'1.1-1' }}%
							</p>
							<p class="text-xs text-blue-700 mt-1">Error Porcentual</p>
						</div>
						<div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-lg border border-emerald-200">
							<p class="text-xs font-semibold text-emerald-700 uppercase mb-1">MAE</p>
							<p class="text-3xl font-bold text-emerald-900">
								{{ prediccionSeleccionada()!.mae | number:'1.1-1' }}
							</p>
							<p class="text-xs text-emerald-700 mt-1">Error Absoluto</p>
						</div>
						<div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
							<p class="text-xs font-semibold text-purple-700 uppercase mb-1">RMSE</p>
							<p class="text-3xl font-bold text-purple-900">
								{{ prediccionSeleccionada()!.rmse | number:'1.1-1' }}
							</p>
							<p class="text-xs text-purple-700 mt-1">Error Cuadrático</p>
						</div>
						<div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
							<p class="text-xs font-semibold text-amber-700 uppercase mb-1">Calidad</p>
							<p-tag 
								[value]="prediccionSeleccionada()!.calidadPrediccion" 
								[severity]="getSeverityCalidad(prediccionSeleccionada()!.calidadPrediccion)"
								styleClass="text-xl px-4 py-2 mt-2">
							</p-tag>
						</div>
					</div>
				</div>

				<!-- Gráfico -->
				<div class="bg-white rounded-xl shadow-sm p-6">
					<h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
						<i class="pi pi-chart-line text-blue-600"></i>
						Análisis de Demanda: Histórico vs Predicción
					</h4>
					<div style="height: 400px;" class="bg-slate-50 rounded-lg p-4">
						<p-chart type="line" [data]="chartData()" [options]="chartOptions()"></p-chart>
					</div>
				</div>

				<!-- Características de la Serie -->
				<div class="grid grid-cols-2 gap-4">
					<div class="bg-white rounded-lg shadow-sm p-5">
						<div class="flex items-center gap-3">
							<div [class]="prediccionSeleccionada()!.tieneTendencia ? 
							               'bg-emerald-100 text-emerald-600' : 
							               'bg-slate-100 text-slate-400'"
							     class="w-12 h-12 rounded-full flex items-center justify-center">
								<i class="pi" [class]="prediccionSeleccionada()!.tieneTendencia ? 
								                        'pi-check-circle' : 'pi-times-circle'"
								   class="text-2xl"></i>
							</div>
							<div>
								<p class="font-semibold text-slate-800">Tendencia Detectada</p>
								<p class="text-sm text-slate-600">
									{{ prediccionSeleccionada()!.tieneTendencia ? 
									   'La serie presenta tendencia clara' : 
									   'Sin tendencia significativa' }}
								</p>
							</div>
						</div>
					</div>
					<div class="bg-white rounded-lg shadow-sm p-5">
						<div class="flex items-center gap-3">
							<div [class]="prediccionSeleccionada()!.tieneEstacionalidad ? 
							               'bg-blue-100 text-blue-600' : 
							               'bg-slate-100 text-slate-400'"
							     class="w-12 h-12 rounded-full flex items-center justify-center">
								<i class="pi" [class]="prediccionSeleccionada()!.tieneEstacionalidad ? 
								                        'pi-check-circle' : 'pi-times-circle'"
								   class="text-2xl"></i>
							</div>
							<div>
								<p class="font-semibold text-slate-800">Estacionalidad Detectada</p>
								<p class="text-sm text-slate-600">
									{{ prediccionSeleccionada()!.tieneEstacionalidad ? 
									   'Patrones estacionales presentes' : 
									   'Sin estacionalidad significativa' }}
								</p>
							</div>
						</div>
					</div>
				</div>

				<!-- Optimización EOQ/ROP -->
				<div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-sm p-6 border border-purple-200">
					<h4 class="text-lg font-bold text-purple-900 mb-4 flex items-center gap-2">
						<i class="pi pi-bolt"></i>
						Optimización de Inventario
					</h4>
					<div class="grid grid-cols-2 gap-6">
						<div class="bg-white rounded-lg p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-3">
								<div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center">
									<i class="pi pi-box text-lg"></i>
								</div>
								<div>
									<p class="text-xs font-semibold text-slate-600 uppercase">EOQ</p>
									<p class="text-xs text-slate-500">Cantidad Óptima de Pedido</p>
								</div>
							</div>
							<p class="text-4xl font-bold text-blue-600">
								{{ prediccionSeleccionada()!.cantidadOptimaPedido }}
							</p>
							<p class="text-sm text-slate-600 mt-2">
								Minimiza costos de pedido e inventario
							</p>
						</div>
						<div class="bg-white rounded-lg p-5 shadow-sm">
							<div class="flex items-center gap-3 mb-3">
								<div class="bg-purple-100 text-purple-600 w-10 h-10 rounded-full flex items-center justify-center">
									<i class="pi pi-flag text-lg"></i>
								</div>
								<div>
									<p class="text-xs font-semibold text-slate-600 uppercase">ROP</p>
									<p class="text-xs text-slate-500">Punto de Reorden</p>
								</div>
							</div>
							<p class="text-4xl font-bold text-purple-600">
								{{ prediccionSeleccionada()!.puntoReorden }}
							</p>
							<p class="text-sm text-slate-600 mt-2">
								Momento ideal para realizar nuevo pedido
							</p>
						</div>
					</div>
				</div>

				<!-- Advertencias y Recomendaciones -->
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					@if (prediccionSeleccionada()!.advertencias.length > 0) {
						<div class="bg-amber-50 border border-amber-200 rounded-lg p-5">
							<h4 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
								<i class="pi pi-exclamation-triangle text-xl"></i>
								Advertencias
							</h4>
							<ul class="space-y-2">
								@for (adv of prediccionSeleccionada()!.advertencias; track $index) {
									<li class="flex items-start gap-2 text-sm text-amber-900">
										<i class="pi pi-circle-fill text-xs mt-1"></i>
										<span>{{ adv }}</span>
									</li>
								}
							</ul>
						</div>
					}

					@if (prediccionSeleccionada()!.recomendaciones.length > 0) {
						<div class="bg-blue-50 border border-blue-200 rounded-lg p-5">
							<h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
								<i class="pi pi-lightbulb text-xl"></i>
								Recomendaciones
							</h4>
							<ul class="space-y-2">
								@for (rec of prediccionSeleccionada()!.recomendaciones; track $index) {
									<li class="flex items-start gap-2 text-sm text-blue-900">
										<i class="pi pi-circle-fill text-xs mt-1"></i>
										<span>{{ rec }}</span>
									</li>
								}
							</ul>
						</div>
					}
				</div>
			</div>
		}

		<ng-template pTemplate="footer">
			<button 
				pButton 
				type="button" 
				label="Cerrar" 
				icon="pi pi-times"
				class="p-button-outlined" 
				(click)="mostrarDetallePrediccion.set(false)">
			</button>
		</ng-template>
	</p-dialog>
</div>
